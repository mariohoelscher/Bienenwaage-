<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hölschers Bienen</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <style>
    body { background-color: #121212; color: white; font-family: Arial, sans-serif; margin: 0; }
    header { padding: 1rem; text-align: center; font-size: 1.5rem; }
    canvas { max-width: 100%; margin: 20px auto; display: block; }
    #settings { position: fixed; top: 10px; right: 10px; cursor: pointer; }
    #settingsPanel { display: none; position: fixed; top: 50px; right: 10px; background: #222; padding: 1rem; border-radius: 10px; }
    .battery { width:200px;height:50px;border:2px solid white;position:relative;margin:20px auto; }
    .battery-level { height:100%; background:green; }
    .battery-text { position:absolute;top:15px;left:80px; }
  </style>
</head>
<body>
  <header>Hölschers Bienen</header>

  <div style="width:90%; margin:auto;">
    <h2>Gewicht</h2>
    <canvas id="weightChart"></canvas>

    <h2>Temperatur innen</h2>
    <canvas id="tempChart"></canvas>

    <h2>Außentemperatur</h2>
    <canvas id="outTempChart"></canvas>

    <h2>Luftfeuchtigkeit</h2>
    <canvas id="humChart"></canvas>

    <h2>Batterie</h2>
    <div id="battery" class="battery"><div id="batteryLevel" class="battery-level"></div><span id="batteryText" class="battery-text"></span></div>
  </div>

  <div id="settings">⚙️</div>
  <div id="settingsPanel">
    <label><input type="checkbox" id="notifyBattery"> Batterie <10%</label><br>
    <label><input type="checkbox" id="notifyTemp"> Temperatur ≤0°C</label><br>
    <label><input type="checkbox" id="notifySwarm"> Schwarmalarm</label>
  </div>

  <script>
    const API_URL = "https://api.thingspeak.com/channels/1228597/feeds.json?api_key=TF002R5TSCHF6RNN&results=2000";

    async function fetchData() {
      const res = await fetch(API_URL);
      const json = await res.json();
      return json.feeds.map(feed => ({
        time: new Date(feed.created_at).getTime(),
        temp: parseFloat(feed.field1),
        outTemp: parseFloat(feed.field2),
        hum: parseFloat(feed.field3),
        battery: parseFloat(feed.field5),
        weight: parseFloat(feed.field6),
        freeze: feed.field4 ? parseInt(feed.field4) : 0
      }));
    }

    function createChart(ctx, label, data, color="yellow") {
      return new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            label: label,
            data: data.map(d => ({x: d.time, y: d.value})),
            borderColor: color,
            backgroundColor: color,
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { type: 'time', time: { unit: 'hour' }, ticks: { color: 'white' } },
            y: { ticks: { color: 'white' } }
          },
          plugins: { legend: { labels: { color: 'white' } } }
        }
      });
    }

    function updateBattery(voltage) {
      const percent = Math.min(100, Math.max(0, (voltage - 8.4) / (12.5 - 8.4) * 100));
      const level = document.getElementById('batteryLevel');
      const text = document.getElementById('batteryText');
      level.style.width = percent + "%";
      text.textContent = percent.toFixed(1) + "% (" + voltage.toFixed(2) + "V)";
      if (percent < 20) level.style.background = "red";
      else if (percent < 50) level.style.background = "orange";
      else level.style.background = "green";
    }

    async function init() {
      const data = await fetchData();

      // Gewicht
      createChart(document.getElementById('weightChart'), "Gewicht (kg)", data.map(d => ({time:d.time, value:d.weight})), "cyan");
      // Temperatur innen
      createChart(document.getElementById('tempChart'), "Temperatur (°C)", data.map(d => ({time:d.time, value:d.temp})), "orange");
      // Außentemperatur
      createChart(document.getElementById('outTempChart'), "Außentemperatur (°C)", data.map(d => ({time:d.time, value:d.outTemp})), "red");
      // Luftfeuchtigkeit
      createChart(document.getElementById('humChart'), "Luftfeuchtigkeit (%)", data.map(d => ({time:d.time, value:d.hum})), "lightblue");

      // Batterie nur letztes Element
      if (data.length > 0) {
        updateBattery(data[data.length-1].battery);
      }
    }

    init();

    // Settings öffnen/schließen
    document.getElementById('settings').addEventListener('click', () => {
      const panel = document.getElementById('settingsPanel');
      panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    });
  </script>
</body>
</html>
