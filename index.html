<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>H√∂lschers Bienen</title>

<!-- PWA manifest & theme -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f0f10">
<link rel="apple-touch-icon" href="icon-192.png">

<!-- Chart.js + date adapter -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<style>
  :root{
    --bg:#0f0f10; --card:#171819; --fg:#e8e8e8; --muted:#9aa0a6; --accent:#ffd54f;
    --success:#28a745; --warn:#ffb300; --danger:#dc3545;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: Inter, Roboto, Arial, Helvetica, sans-serif;
    background:linear-gradient(180deg,#0c0c0c 0%, #0f0f10 100%);
    color:var(--fg);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:16px;
  }

  header{display:flex;align-items:center;justify-content:space-between;gap:12px;max-width:1200px;margin:0 auto;}
  header h1{margin:0;font-size:20px}
  header .meta{color:var(--muted);font-size:13px}

  .controls{max-width:1200px;margin:12px auto;display:flex;gap:12px;align-items:center;justify-content:flex-start;flex-wrap:wrap}
  select,button,input{background:var(--card);color:var(--fg);border:1px solid #232323;padding:8px;border-radius:8px;font-size:14px}
  button.primary{background:linear-gradient(180deg,var(--accent),#e6b800);border:none;color:#111;font-weight:700;cursor:pointer}
  .gear{margin-left:auto}

  .layout{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:1000px){ .layout{grid-template-columns:1fr 1fr} }

  .card{
    background:var(--card);
    border-radius:12px;
    padding:12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.5);
    position:relative;
    min-height:100px;
  }
  .card h2{margin:0 0 8px;font-size:15px;display:flex;justify-content:space-between;align-items:center}
  .subtitle{color:var(--muted);font-size:13px}
  canvas{width:100% !important;height:220px !important;background:#0b0b0b;border-radius:8px}

  /* Battery */
  .battery{width:220px;height:64px;border-radius:10px;border:3px solid #bdbdbd;background:#070707;margin:10px auto;position:relative;cursor:pointer}
  .battery::after{content:'';position:absolute;top:18px;right:8px;width:12px;height:28px;background:#bdbdbd;border-radius:2px}
  .battery-level{height:100%;width:10%;border-radius:6px 0 0 6px;transition:width .6s;background:linear-gradient(90deg,#4caf50,#8bc34a);display:flex;align-items:center;justify-content:center;font-weight:700;color:#000}

  /* Freeze area */
  .freeze-area{display:flex;gap:12px;align-items:center;justify-content:center;margin:12px 0}
  .freeze-btn{font-size:36px;background:none;border:none;cursor:pointer}
  .freeze-text{font-weight:700;color:#4fc3f7}

  /* modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:300;padding:20px}
  .modal .card{max-width:720px;width:100%}
  .modal h3{margin-top:0}
  .toast{position:fixed;right:18px;bottom:18px;background:#111;padding:10px 14px;border-radius:8px;color:#fff;display:none;z-index:90}

  /* small helpers */
  .small{font-size:13px;color:var(--muted)}
  footer{max-width:1200px;margin:18px auto;text-align:center;color:var(--muted);font-size:13px}
</style>
</head>
<body>

<header>
  <h1>H√∂lschers Bienen</h1>
  <div class="meta">Status: <span id="appStatus">OK</span></div>
</header>

<div class="controls">
  <label>
    Zeitraum:
    <select id="timeRange">
      <option value="today">Heute</option>
      <option value="24h">Letzte 24 Stunden</option>
      <option value="3d">Letzte 3 Tage</option>
      <option value="7d">Letzte 7 Tage</option>
      <option value="30d">Letzter Monat</option>
    </select>
  </label>

  <button id="reloadBtn" class="primary">Neu laden</button>

  <button id="gearBtn" class="gear" title="Einstellungen">‚öôÔ∏è</button>
</div>

<div id="settingsPanel" style="display:none;position:fixed;right:18px;top:64px;background:var(--card);padding:12px;border-radius:8px;border:1px solid #333;z-index:100">
  <strong>Einstellungen</strong>
  <div style="margin-top:8px">
    <label><input type="checkbox" id="notifBattery"> Batterie &lt; 10%</label><br>
    <label><input type="checkbox" id="notifSwarm"> Schwarmalarm (starker Gewichtsverlust)</label><br>
    <label><input type="checkbox" id="notifFrost"> Frostwarnung (‚â§ 0¬∞C)</label>
  </div>
  <div class="small" style="margin-top:8px">Einstellungen werden lokal gespeichert</div>
</div>

<main class="layout" id="mainLayout">
  <section class="card" id="card-weight">
    <h2>Gewicht <span id="latestWeight" class="subtitle"></span></h2>
    <canvas id="chartWeight"></canvas>
  </section>

  <section class="card" id="card-temp">
    <h2>Temperatur innen <span id="latestTemp" class="subtitle"></span></h2>
    <canvas id="chartTemp"></canvas>
  </section>

  <section class="card" id="card-outtemp">
    <h2>Temperatur au√üen <span id="latestOutTemp" class="subtitle"></span></h2>
    <canvas id="chartOutTemp"></canvas>
  </section>

  <section class="card" id="card-hum">
    <h2>Luftfeuchtigkeit <span id="latestHum" class="subtitle"></span></h2>
    <canvas id="chartHum"></canvas>
  </section>

  <section class="card" id="card-bat">
    <h2>Batterie <span id="latestBat" class="subtitle"></span></h2>
    <div class="battery" id="batteryBox" title="Batterie anklicken">
      <div id="batteryLevel" class="battery-level">--%</div>
    </div>
    <div id="batteryForecast" class="small" style="text-align:center;margin-top:6px"></div>
  </section>

  <section class="card" id="card-freeze">
    <h2>Freeze (Gewicht)</h2>
    <div class="freeze-area">
      <button id="freezeBtn" class="freeze-btn" title="Freeze an/aus">üêù</button>
      <div id="freezeStatus" class="freeze-text"></div>
    </div>
    <div class="small" style="text-align:center">Beim Aktivieren wird das Gewicht ab dem Zeitpunkt auf den aktuellen Wert eingefroren (Field4 auf ThingSpeak).</div>
  </section>
</main>

<div id="modal" class="modal"><div class="card" id="modalCard"></div></div>
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ======================================================
   Vollst√§ndiger JavaScript-Teil (langer, stabiler Stand)
   ====================================================== */

/* CONFIG */
const CHANNEL_ID = 1228597;
const READ_KEY = "TF002R5TSCHF6RNN";
const WRITE_KEY = "AIWO5QCDY7MQ4EXE";
const RESULTS_MAX = 8000;
const VOLT_MIN = 8.4, VOLT_MAX = 12.5;
const FETCH_INTERVAL = 10 * 60 * 1000; // 10 minutes

/* STATE */
let allFeeds = [];       // normalized chronological feed objects
let freezeIntervals = []; // intervals reconstructed from field4 events
let charts = {};        // Chart.js instances
let currentRange = 'today';

/* HELPERS */
const $ = id => document.getElementById(id);
function toast(msg, t=3000){ const el=$('toast'); el.textContent=msg; el.style.display='block'; clearTimeout(el._to); el._to=setTimeout(()=>el.style.display='none',t); }
function parseNum(v){ const n=parseFloat(v); return isNaN(n)?null:n; }
function voltPct(v){ if(v===null) return 0; return Math.round(Math.max(0,Math.min(100, ((v - VOLT_MIN)/(VOLT_MAX - VOLT_MIN))*100))); }
function isoTS(d){ return d.toISOString().slice(0,19).replace('T',' '); }

/* FETCH & NORMALIZE */
async function fetchAll(rangeKey = currentRange){
  // build URL with days/minutes parameter to reduce data
  let url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=${RESULTS_MAX}`;
  if(rangeKey === 'today') url += '&days=1';
  else if(rangeKey === '24h') url += '&minutes=1440';
  else if(rangeKey === '3d') url += '&days=3';
  else if(rangeKey === '7d') url += '&days=7';
  else if(rangeKey === '30d') url += '&days=30';

  try{
    const r = await fetch(url);
    const j = await r.json();
    const feeds = (j.feeds||[]);
    // normalize chronological
    allFeeds = feeds.map(f => ({
      time: new Date(f.created_at),
      field1: parseNum(f.field1),
      field2: parseNum(f.field2),
      field3: parseNum(f.field3),
      field4: (f.field4 === "1" ? 1 : (f.field4 === "0" ? 0 : null)),
      field5: parseNum(f.field5),
      field6: parseNum(f.field6)
    }));
    computeFreezeIntervalsFromFeeds();
    renderAll();
  }catch(e){
    console.error('fetch fail', e);
    toast('Fehler beim Laden');
  }
}

/* RECONSTRUCT FREEZE INTERVALS FROM field4 events
   - Start when field4 === 1 (if not inside interval)
   - End when field4 === 0
   - Determine freezeValue = last available weight at or before start (fallback to last known)
*/
function computeFreezeIntervalsFromFeeds(){
  freezeIntervals = [];
  let open = null;
  for(const f of allFeeds){
    if(f.field4 === 1 && open === null){
      open = { start: f.time, end: null, freezeValue: null };
    } else if(f.field4 === 0 && open !== null){
      open.end = f.time;
      // find last weight <= open.start
      let freezeVal = null;
      for(let i = allFeeds.length - 1; i >= 0; i--){
        if(allFeeds[i].time <= open.start && allFeeds[i].field6 != null){
          freezeVal = allFeeds[i].field6;
          break;
        }
      }
      if(freezeVal === null){
        for(let i = allFeeds.length-1;i>=0;i--){ if(allFeeds[i].field6!=null){ freezeVal=allFeeds[i].field6; break;} }
      }
      open.freezeValue = freezeVal;
      freezeIntervals.push(open);
      open = null;
    }
  }
  if(open !== null){
    // still open interval
    let freezeVal = null;
    for(let i=allFeeds.length-1;i>=0;i--){
      if(allFeeds[i].time <= open.start && allFeeds[i].field6 != null){ freezeVal = allFeeds[i].field6; break; }
    }
    if(freezeVal === null){
      for(let i=allFeeds.length-1;i>=0;i--){ if(allFeeds[i].field6!=null){freezeVal=allFeeds[i].field6;break;} }
    }
    open.freezeValue = freezeVal;
    freezeIntervals.push(open);
  }
  // update UI initial state (freeze button)
  const lastFlagFeed = [...allFeeds].reverse().find(f => f.field4 === 1 || f.field4 === 0);
  const isFrozen = lastFlagFeed ? (lastFlagFeed.field4 === 1) : false;
  setFreezeUi(isFrozen);
}

/* return freeze value for a time, or null if not frozen */
function freezeValueForTime(t){
  for(const iv of freezeIntervals){
    const start = iv.start;
    const end = iv.end;
    if(t >= start && (end === null || t <= end)) return iv.freezeValue;
  }
  return null;
}

/* RENDER ALL CHARTS AND UI */
function renderAll(){
  const range = $('timeRange').value;
  currentRange = range;
  // compute start date for filter (client-side)
  const now = new Date();
  let start;
  if(range === 'today') start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  else if(range === '24h') start = new Date(now.getTime() - 24*3600*1000);
  else if(range === '3d') start = new Date(now.getTime() - 3*24*3600*1000);
  else if(range === '7d') start = new Date(now.getTime() - 7*24*3600*1000);
  else if(range === '30d') start = new Date(now.getTime() - 30*24*3600*1000);
  else start = new Date(0);

  const feeds = allFeeds.filter(f => f.time >= start);

  // labels and series as {x:time, y:value} arrays for Chart.js time axis
  const labels = feeds.map(f => f.time);
  const weights = feeds.map(f => {
    const fv = freezeValueForTime(f.time);
    return (fv !== null && fv !== undefined) ? fv : f.field6;
  });
  const temps = feeds.map(f => f.field1);
  const outtemps = feeds.map(f => f.field2);
  const hums = feeds.map(f => f.field3);

  // destroy old charts
  Object.values(charts).forEach(c=>{ try{ c.destroy(); }catch(e){} });
  charts = {};

  const commonOptions = {
    responsive:true,
    maintainAspectRatio:false,
    scales:{
      x:{ type:'time', time:{ tooltipFormat:'dd.MM. HH:mm' }, ticks:{ color: '#e8e8e8' } },
      y:{ ticks:{ color: '#e8e8e8' } }
    },
    plugins:{ legend:{ display:false } }
  };

  charts.weight = new Chart($('chartWeight').getContext('2d'), {
    type:'line',
    data:{ labels, datasets:[{ label:'Gewicht (kg)', data:weights, borderColor:'#ffb74d', spanGaps:true, pointRadius:2, tension:0.2 }] },
    options: commonOptions
  });

  charts.temp = new Chart($('chartTemp').getContext('2d'), {
    type:'line',
    data:{ labels, datasets:[{ label:'Temp innen (¬∞C)', data:temps, borderColor:'#ff6b6b', spanGaps:true, pointRadius:2, tension:0.2 }] },
    options: commonOptions
  });

  charts.outtemp = new Chart($('chartOutTemp').getContext('2d'), {
    type:'line',
    data:{ labels, datasets:[{ label:'Temp au√üen (¬∞C)', data:outtemps, borderColor:'#42a5f5', spanGaps:true, pointRadius:2, tension:0.2 }] },
    options: commonOptions
  });

  charts.hum = new Chart($('chartHum').getContext('2d'), {
    type:'line',
    data:{ labels, datasets:[{ label:'Luftfeuchte (%)', data:hums, borderColor:'#9be7a9', spanGaps:true, pointRadius:2, tension:0.2 }] },
    options: commonOptions
  });

  // update latest values (find last non-null)
  const lastValid = (key) => { for(let i=feeds.length-1;i>=0;i--) if(feeds[i][key] != null) return feeds[i]; return null; };
  const lvW = lastValid('field6'); if(lvW) $('latestWeight').textContent = `(${lvW.field6.toFixed(2)} kg, ${lvW.time.toLocaleTimeString()})`; else $('latestWeight').textContent='';
  const lvT = lastValid('field1'); if(lvT) $('latestTemp').textContent = `(${lvT.field1.toFixed(1)} ¬∞C, ${lvT.time.toLocaleTimeString()})`; else $('latestTemp').textContent='';
  const lvO = lastValid('field2'); if(lvO) $('latestOutTemp').textContent = `(${lvO.field2.toFixed(1)} ¬∞C, ${lvO.time.toLocaleTimeString()})`; else $('latestOutTemp').textContent='';
  const lvH = lastValid('field3'); if(lvH) $('latestHum').textContent = `(${lvH.field3.toFixed(0)} %, ${lvH.time.toLocaleTimeString()})`; else $('latestHum').textContent='';

  // battery
  const lastBatt = (feeds.slice().reverse().find(f => f.field5 != null) || null);
  if(lastBatt){
    const pct = voltPct(lastBatt.field5);
    const level = $('batteryLevel');
    level.style.width = pct + '%';
    level.textContent = pct + '%';
    if(pct > 60) level.style.background = 'linear-gradient(90deg,#28a745,#34d058)';
    else if(pct > 30) level.style.background = 'linear-gradient(90deg,#ffc107,#ffcd39)';
    else level.style.background = 'linear-gradient(90deg,#dc3545,#ff6b6b)';
    $('latestBat').textContent = `(${lastBatt.field5.toFixed(2)} V, ${lastBatt.time.toLocaleTimeString()})`;
    // battery forecast computed on click to avoid repeated heavy calculations
  } else {
    $('batteryLevel').style.width = '0%'; $('batteryLevel').textContent = '--%'; $('latestBat').textContent = '';
  }

  // attach click handlers for current displayed feeds
  attachClicks(feeds);
}

/* attachClicks: clicking on charts shows modal with stats; clicking battery shows forecast */
function attachClicks(displayedFeeds){
  const mapping = [
    {canvas:'chartWeight', key:'field6', unit:'kg', title:'Gewicht'},
    {canvas:'chartTemp', key:'field1', unit:'¬∞C', title:'Temperatur innen'},
    {canvas:'chartOutTemp', key:'field2', unit:'¬∞C', title:'Temperatur au√üen'},
    {canvas:'chartHum', key:'field3', unit:'%', title:'Luftfeuchte'}
  ];
  mapping.forEach(m=>{
    const el = $(m.canvas);
    el.style.cursor = 'pointer';
    el.onclick = () => {
      const vals = displayedFeeds.map(f => {
        if(m.key === 'field6'){
          const fv = freezeValueForTime(f.time);
          return (fv !== null && fv !== undefined) ? fv : f.field6;
        }
        return f[m.key];
      }).filter(v => typeof v === 'number' && !isNaN(v));
      if(!vals.length){ showModal(`<h3>${m.title}</h3><p>Keine Daten im ausgew√§hlten Zeitraum</p>`); return; }
      const min = Math.min(...vals), max = Math.max(...vals), avg = vals.reduce((a,b)=>a+b,0)/vals.length;
      showModal(`<h3>${m.title}</h3><p>√ò: ${avg.toFixed(2)} ${m.unit}<br>Min: ${min.toFixed(2)} ${m.unit}<br>Max: ${max.toFixed(2)} ${m.unit}</p>`);
    };
  });

  $('batteryBox').onclick = async () => {
    const now = new Date();
    const threeDaysAgo = new Date(now.getTime() - 3*24*3600*1000);
    const arr = allFeeds.filter(f => f.time >= threeDaysAgo && f.field5 != null).map(f => ({t:f.time, v:f.field5}));
    if(arr.length < 2){ showModal('<h3>Batterie</h3><p>Nicht genug Daten f√ºr Prognose</p>'); return; }
    const first = arr[0], last = arr[arr.length-1];
    const hours = (last.t - first.t)/3600000;
    const slope = (last.v - first.v)/hours; // V/hour
    if(Math.abs(slope) < 1e-6){ showModal('<h3>Batterie</h3><p>Prognose: stabil</p>'); return; }
    if(slope < 0){
      const hoursLeft = (last.v - VOLT_MIN)/Math.abs(slope);
      const days = Math.floor(hoursLeft/24), hrs = Math.round(hoursLeft%24);
      showModal(`<h3>Batterie</h3><p>Trend: ${(slope*24).toFixed(3)} V/Tag<br>Restlaufzeit: ${days} Tage ${hrs} Std</p>`);
    } else {
      showModal(`<h3>Batterie</h3><p>Trend: +${(slope*24).toFixed(3)} V/Tag (steigend)</p>`);
    }
  };
}

/* Modal helpers */
function showModal(html){
  $('modalCard').innerHTML = html + '<div style="text-align:right;margin-top:10px"><button onclick="closeModal()">Schlie√üen</button></div>';
  $('modal').style.display = 'flex';
}
function closeModal(){ $('modal').style.display = 'none'; }

/* Freeze toggle: write field4 to ThingSpeak and refresh feeds so intervals are reconstructed */
function setFreezeUi(isFrozen){
  const btn = $('freezeBtn'), status = $('freezeStatus');
  if(isFrozen){ btn.textContent = 'üêù‚ùÑÔ∏è'; status.textContent = 'Eingefroren'; }
  else { btn.textContent = 'üêù'; status.textContent = ''; }
}

async function toggleFreeze(){
  // find last flag in allFeeds
  const lastFlagFeed = [...allFeeds].reverse().find(f => f.field4 === 1 || f.field4 === 0);
  const currentlyFrozen = lastFlagFeed ? (lastFlagFeed.field4 === 1) : false;
  const newVal = currentlyFrozen ? 0 : 1;
  // optimistic UI update
  setFreezeUi(newVal === 1);
  try{
    await fetch(`https://api.thingspeak.com/update?api_key=${WRITE_KEY}&field4=${newVal}`);
    // re-fetch to rebuild intervals from server source-of-truth
    await fetchAll(currentRange);
    toast(newVal === 1 ? 'Freeze gesetzt' : 'Freeze aufgehoben');
  }catch(e){
    console.error('write fail', e);
    toast('Fehler beim Schreiben des Freeze-Flags');
    computeFreezeIntervalsFromFeeds(); // revert UI
  }
}

/* Settings persistence */
function loadSettings(){
  const nb = localStorage.getItem('notifBattery') === '1';
  const ns = localStorage.getItem('notifSwarm') === '1';
  const nf = localStorage.getItem('notifFrost') === '1';
  $('notifBattery').checked = nb;
  $('notifSwarm').checked = ns;
  $('notifFrost').checked = nf;
}
function saveSettings(){
  localStorage.setItem('notifBattery', $('notifBattery').checked ? '1':'0');
  localStorage.setItem('notifSwarm', $('notifSwarm').checked ? '1':'0');
  localStorage.setItem('notifFrost', $('notifFrost').checked ? '1':'0');
  toast('Einstellungen gespeichert');
}

/* UI wiring */
$('reloadBtn').addEventListener('click', ()=>fetchAll(currentRange));
$('timeRange').addEventListener('change', ()=>fetchAll(document.getElementById('timeRange').value));
$('freezeBtn').addEventListener('click', toggleFreeze);
$('gearBtn').addEventListener('click', ()=>{ $('settingsPanel').style.display = $('settingsPanel').style.display === 'block' ? 'none' : 'block'; });
$('settingsPanel').addEventListener('change', saveSettings);

/* INIT */
loadSettings();
fetchAll(currentRange);
setInterval(()=>fetchAll(currentRange), FETCH_INTERVAL);

</script>

<footer>
  &copy; H√∂lschers Bienen ‚Äî Daten via ThingSpeak (Channel: 1228597)
</footer>

</body>
</html>
