<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>H√∂lschers Bienen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #121212;
      color: #e0e0e0;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    h2 {
      margin-top: 20px;
    }
    .chart-container {
      width: 90%;
      max-width: 600px;
      margin: 20px auto;
    }
    canvas {
      background: #1e1e1e;
      border-radius: 10px;
      padding: 10px;
    }
    .battery {
      margin: 30px auto;
      width: 200px;
      height: 80px;
      border: 4px solid #fff;
      border-radius: 8px;
      position: relative;
      background: #333;
      cursor: pointer;
    }
    .battery::after {
      content: "";
      position: absolute;
      right: -12px;
      top: 25px;
      width: 10px;
      height: 30px;
      background: #fff;
      border-radius: 2px;
    }
    .battery-level {
      height: 100%;
      background: linear-gradient(to right, #4caf50, #8bc34a);
      width: 50%;
      border-radius: 4px;
      transition: width 0.3s;
    }
    /* Overlay f√ºr Infos */
    .overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      color: #fff;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 1000;
    }
    .overlay.active {
      display: flex;
    }
    .overlay button {
      margin-top: 20px;
      padding: 10px 20px;
      border: none;
      background: #4caf50;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      border-radius: 6px;
    }
    /* Freeze Button */
    .freeze-container {
      margin: 30px auto;
    }
    .freeze-btn {
      font-size: 40px;
      cursor: pointer;
      background: none;
      border: none;
    }
    .freeze-status {
      margin-top: 10px;
      font-size: 18px;
      color: #4fc3f7;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>H√∂lschers Bienen</h1>

  <!-- Diagramme -->
  <div class="chart-container">
    <h2 id="weightTitle">Gewicht</h2>
    <canvas id="weightChart"></canvas>
  </div>

  <div class="chart-container">
    <h2 id="tempTitle">Temperatur</h2>
    <canvas id="tempChart"></canvas>
  </div>

  <div class="chart-container">
    <h2 id="outsideTempTitle">Au√üentemperatur</h2>
    <canvas id="outsideTempChart"></canvas>
  </div>

  <div class="chart-container">
    <h2 id="humidityTitle">Luftfeuchtigkeit</h2>
    <canvas id="humidityChart"></canvas>
  </div>

  <!-- Batterie -->
  <h2 id="batteryTitle">Batterie</h2>
  <div class="battery" id="battery">
    <div class="battery-level" id="batteryLevel"></div>
  </div>

  <!-- Freeze Button -->
  <div class="freeze-container">
    <button class="freeze-btn" id="freezeBtn">üêù</button>
    <div class="freeze-status" id="freezeStatus"></div>
  </div>

  <!-- Overlay -->
  <div class="overlay" id="overlay">
    <div id="overlayContent"></div>
    <button onclick="closeOverlay()">Schlie√üen</button>
  </div>

  <script>
    const channelId = 1228597;
    const readApiKey = "TF002R5TSCHF6RNN";
    const writeApiKey = "AIWO5QCDY7MQ4EXE";
    const apiUrl = `https://api.thingspeak.com/channels/${channelId}/feeds.json?api_key=${readApiKey}&results=500`;

    let weightChart, tempChart, outsideTempChart, humidityChart;

    async function fetchData() {
      const res = await fetch(apiUrl);
      const data = await res.json();
      const feeds = data.feeds;

      const times = feeds.map(f => new Date(f.created_at));
      const weight = feeds.map(f => parseFloat(f.field6));
      const temp = feeds.map(f => parseFloat(f.field1));
      const outsideTemp = feeds.map(f => parseFloat(f.field2));
      const humidity = feeds.map(f => parseFloat(f.field3));
      const battery = feeds.map(f => parseFloat(f.field5));

      // Charts
      renderChart("weightChart", "Gewicht [kg]", times, weight, v => updateTitle("weightTitle", "Gewicht", v));
      renderChart("tempChart", "Temperatur [¬∞C]", times, temp, v => updateTitle("tempTitle", "Temperatur", v));
      renderChart("outsideTempChart", "Au√üentemperatur [¬∞C]", times, outsideTemp, v => updateTitle("outsideTempTitle", "Au√üentemperatur", v));
      renderChart("humidityChart", "Luftfeuchtigkeit [%]", times, humidity, v => updateTitle("humidityTitle", "Luftfeuchtigkeit", v));

      // Batterie
      const lastBattery = battery[battery.length - 1];
      updateBattery(lastBattery);

      // Battery overlay
      document.getElementById("battery").onclick = () => {
        const prediction = batteryPrediction(battery, times);
        showOverlay(`<h2>Batterie-Prognose</h2><p>${prediction}</p>`);
      };
    }

    function renderChart(canvasId, label, labels, data, cb) {
      const ctx = document.getElementById(canvasId).getContext("2d");
      if (window[canvasId]) window[canvasId].destroy();
      window[canvasId] = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label,
            data,
            borderColor: "lightblue",
            borderWidth: 2,
            fill: false,
            spanGaps: true
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { x: { type: "time", time: { unit: "hour" } } }
        }
      });

      const lastVal = data[data.length - 1];
      const lastTime = labels[labels.length - 1];
      cb({ val: lastVal, time: lastTime });

      document.getElementById(canvasId).onclick = () => {
        const vals = data.filter(v => !isNaN(v));
        const min = Math.min(...vals);
        const max = Math.max(...vals);
        const avg = (vals.reduce((a,b) => a+b,0)/vals.length).toFixed(2);
        showOverlay(`<h2>${label}</h2><p>Min: ${min}<br>Max: ${max}<br>√ò: ${avg}</p>`);
      };
    }

    function updateTitle(id, label, {val, time}) {
      const dateStr = new Date(time).toLocaleTimeString();
      document.getElementById(id).innerText = `${label}: ${val} (${dateStr})`;
    }

    function updateBattery(voltage) {
      const percent = Math.max(0, Math.min(100, ((voltage - 8.4) / (12.5 - 8.4)) * 100));
      document.getElementById("batteryLevel").style.width = percent + "%";
      document.getElementById("batteryTitle").innerText = `Batterie: ${voltage.toFixed(2)} V (${percent.toFixed(0)}%)`;
    }

    function batteryPrediction(battery, times) {
      if (battery.length < 2) return "Nicht genug Daten";
      const first = battery[0], last = battery[battery.length-1];
      const firstTime = times[0], lastTime = times[times.length-1];
      const diffHours = (lastTime - firstTime) / 3600000;
      const diff = last - first;
      if (diff === 0) return "Kein Verbrauch erkennbar";
      const rate = diff / diffHours;
      const remaining = (last - 8.4) / Math.abs(rate);
      const days = (remaining/24).toFixed(1);
      return rate < 0 ? `Voraussichtlich leer in ${days} Tagen` : `Steigt aktuell (+${rate.toFixed(3)} V/h)`;
    }

    function showOverlay(html) {
      document.getElementById("overlayContent").innerHTML = html;
      document.getElementById("overlay").classList.add("active");
    }

    function closeOverlay() {
      document.getElementById("overlay").classList.remove("active");
    }

    // Freeze Button
    const freezeBtn = document.getElementById("freezeBtn");
    const freezeStatus = document.getElementById("freezeStatus");
    let frozen = false;

    async function toggleFreeze() {
      frozen = !frozen;
      const value = frozen ? 1 : 0;
      await fetch(`https://api.thingspeak.com/update?api_key=${writeApiKey}&field4=${value}`);
      if (frozen) {
        freezeBtn.textContent = "üêù‚ùÑÔ∏è";
        freezeStatus.textContent = "Eingefroren";
      } else {
        freezeBtn.textContent = "üêù";
        freezeStatus.textContent = "";
      }
    }

    freezeBtn.addEventListener("click", toggleFreeze);

    fetchData();
    setInterval(fetchData, 10 * 60 * 1000);
  </script>
</body>
</html>
