<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hölschers Bienen</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body { background:#121212; color:#eee; font-family:sans-serif; margin:0; }
    header { padding:10px; text-align:center; background:#1e1e1e; }
    canvas { max-width:600px; margin:20px auto; display:block; background:#222; border-radius:12px; }
    .battery { width:200px; height:60px; border:2px solid #fff; border-radius:8px; margin:20px auto; position:relative; }
    .battery-level { height:100%; background:limegreen; border-radius:6px; }
    .gear { position:fixed; top:10px; right:10px; cursor:pointer; }
    #settings { display:none; position:fixed; top:50px; right:10px; background:#222; padding:10px; border:1px solid #555; border-radius:8px; }
    #wartung { margin:20px; padding:10px; background:#333; border-radius:8px; }
  </style>
</head>
<body>
  <header><h1>Hölschers Bienen</h1></header>

  <div>
    <label>Zeitraum:
      <select id="timeRange">
        <option value="1">Heute</option>
        <option value="1d">Letzte 24h</option>
        <option value="3">3 Tage</option>
        <option value="7">7 Tage</option>
        <option value="30">Monat</option>
      </select>
    </label>
  </div>

  <canvas id="weightChart"></canvas>
  <canvas id="tempChart"></canvas>
  <canvas id="humidityChart"></canvas>

  <div class="battery" onclick="showBatteryDetails()">
    <div id="batteryLevel" class="battery-level"></div>
  </div>
  <div id="batteryText" style="text-align:center;"></div>

  <img src="https://cdn-icons-png.flaticon.com/512/126/126122.png" width="32" class="gear" onclick="toggleSettings()">

  <div id="settings">
    <h3>Push Benachrichtigungen</h3>
    <label><input type="checkbox" id="notifBattery"> Batterie <10%</label><br>
    <label><input type="checkbox" id="notifTemp"> Frostwarnung</label><br>
    <label><input type="checkbox" id="notifSwarm"> Schwarmalarm</label>
  </div>

  <div id="wartung">
    <h3>Wartung</h3>
    <label>Start: <input type="datetime-local" id="startTime"></label><br>
    <label>Ende: <input type="datetime-local" id="endTime"></label><br>
    <button onclick="saveWartung()">Speichern</button>
    <button onclick="clearWartung()">Löschen</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const channel = 1228597;
    const url = `https://api.thingspeak.com/channels/${channel}/feeds.json?results=2000`;
    let chartWeight, chartTemp, chartHum;
    let wartung = null;

    async function fetchData() {
      try {
        const res = await fetch(url);
        const data = await res.json();
        return data.feeds.map(f => ({
          t: new Date(f.created_at),
          temp: parseFloat(f.field1),
          tempOut: parseFloat(f.field2),
          hum: parseFloat(f.field3),
          freeze: f.field4 ? parseInt(f.field4) : 0,
          battery: parseFloat(f.field5),
          weight: parseFloat(f.field6)
        }));
      } catch(e) {
        console.error("Fehler beim Abrufen", e);
        return [];
      }
    }

    function drawCharts(feeds) {
      if (!feeds.length) return;
      const labels = feeds.map(f => f.t);
      const weights = feeds.map(f => f.weight);
      const temps = feeds.map(f => f.temp);
      const hums = feeds.map(f => f.hum);

      if (chartWeight) chartWeight.destroy();
      if (chartTemp) chartTemp.destroy();
      if (chartHum) chartHum.destroy();

      chartWeight = new Chart(document.getElementById("weightChart"), {
        type: 'line',
        data: { labels, datasets:[{label:"Gewicht (kg)", data:weights, borderColor:"orange"}] },
        options:{ responsive:true, plugins:{ legend:{labels:{color:'#fff'}}}, scales:{ x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}}} }
      });
      chartTemp = new Chart(document.getElementById("tempChart"), {
        type: 'line',
        data: { labels, datasets:[{label:"Temperatur (°C)", data:temps, borderColor:"red"}] },
        options:{ responsive:true, plugins:{ legend:{labels:{color:'#fff'}}}, scales:{ x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}}} }
      });
      chartHum = new Chart(document.getElementById("humidityChart"), {
        type: 'line',
        data: { labels, datasets:[{label:"Luftfeuchtigkeit (%)", data:hums, borderColor:"cyan"}] },
        options:{ responsive:true, plugins:{ legend:{labels:{color:'#fff'}}}, scales:{ x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}}} }
      });

      updateBattery(feeds);
    }

    function updateBattery(feeds) {
      const last = feeds[feeds.length-1];
      const volt = last.battery;
      const percent = Math.max(0, Math.min(100, ((volt-8.4)/(12.5-8.4))*100));
      document.getElementById("batteryLevel").style.width = percent+"%";
      document.getElementById("batteryText").innerText = volt.toFixed(2)+" V ("+percent.toFixed(0)+"%)";
    }

    function toggleSettings(){
      const s = document.getElementById("settings");
      s.style.display = s.style.display==="block" ? "none":"block";
    }

    function showBatteryDetails(){
      alert("Batterie Details folgen...");
    }

    function saveWartung(){
      wartung = {
        start: document.getElementById("startTime").value,
        end: document.getElementById("endTime").value
      };
      alert("Wartung gespeichert: "+JSON.stringify(wartung));
    }
    function clearWartung(){
      wartung = null;
      alert("Wartung gelöscht");
    }

    fetchData().then(drawCharts);
  </script>
</body>
</html>
